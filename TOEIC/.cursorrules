# TOEIC問題生成 自動化ルール

## 目的
TOEIC Part 7の問題を効率的に生成し、自動的に問題フォルダに保存するためのルールです。
ユーザーが問題生成を依頼した際に、設定ファイルを自動読み込み、適切な形式で問題を生成・保存します。

## ファイル構造

### 主要ファイル
- **設定ファイル**: `問題生成器/config.yaml`
- **プロンプトテンプレート**: `問題生成器/prompts.md`
- **問題保存先**: `問題/` フォルダ
- **問題ファイル形式**: `{開始番号}-{終了番号}.md` (例: `1-3.md`, `4-7.md`)

## 問題生成の自動化ルール

### 基本動作
ユーザーが問題生成を依頼した場合、以下の手順を自動的に実行：

1. **設定ファイルの読み込み**
   - `問題生成器/config.yaml` を自動的に読み込む
   - デフォルト設定（`default`セクション）を取得
   - ユーザーが指定したパラメータがあれば、デフォルト設定を上書き

2. **プロンプトテンプレートの参照**
   - `問題生成器/prompts.md` を参照して問題生成プロンプトを作成
   - 難易度、パッセージ数、質問数に応じた適切な指示を含める

3. **問題番号の自動採番**
   - `問題/` フォルダ内の既存ファイルをスキャン
   - ファイル名から最大の終了番号を検出（例: `1-3.md` → 3）
   - 次の問題は連番で開始（例: 最大が3なら、次は `4-{4+質問数-1}.md`）

4. **問題の生成**
   - TOEIC Part 7の形式に準拠した問題を生成
   - 指定されたパッセージ数、質問数、難易度に従う
   - トピックや文書タイプが指定されていれば反映

5. **自動保存**
   - 生成された問題を `問題/` フォルダに保存
   - ファイル名は自動採番された番号を使用

## パラメータ仕様

### デフォルト設定（config.yamlより）
- **パッセージ数**: 1（範囲: 1-3）
- **質問数**: 3（範囲: 3-10）
- **難易度**: "初級"（オプション: "初級"/"中級"/"上級"）
- **文書タイプ**: "ランダム"（config.yamlのdocument_typesリストから選択）

### 難易度の定義
- **初級**: TOEIC 500点以下レベル。簡単な語彙と短い文章。情報は明示的で直接的。
- **中級**: TOEIC 700点以下レベル。一般的なビジネス語彙と標準的な文章。推論が必要な質問を含む。
- **上級**: TOEIC 700点超レベル。高度な語彙と複雑な文章構造。深い推論と複数情報の統合が必要。

### パッセージ数による文章タイプ
- **1パッセージ**: 広告、記事、通知、レビュー、手紙、メールなど
- **2パッセージ**: 広告とレビュー、メールと返信、記事と広告など
- **3パッセージ**: メールチェーン（3通）、広告・記事・レビュー、複数の関連文書など

## 出力形式

### 必須フォーマット
```markdown
## 文章1：[文章タイプ]

[文章内容]

---

[パッセージ数が2以上の場合]
## 文章2：[文章タイプ]

[文章内容]

---

[パッセージ数が3の場合]
## 文章3：[文章タイプ]

[文章内容]

---

## 設問

**1. [質問文]**
(A) [選択肢A]
(B) [選択肢B]
(C) [選択肢C]
(D) [選択肢D]

**2. [質問文]**
(A) [選択肢A]
(B) [選択肢B]
(C) [選択肢C]
(D) [選択肢D]

（以降、指定された質問数まで同様に）
```

### 形式のルール
- 文章番号は連番で開始（文章1、文章2、文章3）
- 各文章のタイプを明記（例: "メール"、"広告"、"記事"）
- 文章間は `---` で区切る
- 設問セクションは `## 設問` で開始
- 質問番号は連番で開始（1, 2, 3...）
- 選択肢は (A), (B), (C), (D) の形式
- 回答や解説は含めない

## 問題生成時の指示

### ユーザーが指定した場合のみ実行
- パラメータが明示的に指定されていない場合は、config.yamlのデフォルト設定を使用
- フォルダ参照（`@問題生成器`）があれば、自動的に設定ファイルを読み込む

### 問題生成プロンプトの作成
以下の情報を含めたプロンプトを作成：

```
TOEIC Part 7の問題を作成してください。

【仕様】
- パッセージ数: [指定された数またはデフォルト]
- 質問数: [指定された数またはデフォルト]
- 難易度: [指定された難易度またはデフォルト] - [難易度の説明]
- トピック: [指定されたトピック、または適切なものを選択]
- 文書タイプ: [指定されたタイプ、またはランダム選択]

【出力形式】
必ず以下のMarkdown形式で出力してください：
[上記の出力形式を参照]

【注意事項】
- 文章は実際のビジネス文書として自然な内容にする
- 質問は様々なタイプを含める（詳細理解、推論、語彙、NOT問題など）
- 回答や解説は含めない
- 文章番号は連番で開始
```

## 問題番号の自動採番ロジック

### 実装手順
1. `問題/` フォルダ内の全ファイルをリストアップ
2. ファイル名から数値を抽出（正規表現: `(\d+)-(\d+)\.md`）
3. 終了番号の最大値を取得
4. 次の問題の開始番号 = 最大終了番号 + 1
5. 終了番号 = 開始番号 + 質問数 - 1

### 例
- 既存ファイル: `1-3.md`（終了番号: 3）
- 質問数: 5
- 次の問題: `4-8.md`（開始番号: 4, 終了番号: 8）

### エラーハンドリング
- ファイルが見つからない場合: 開始番号を1とする
- ファイル名の形式が不正な場合: そのファイルを無視して処理を続行

## ユーザー指示の解釈

### 簡易指示（推奨）
```
@問題生成器 フォルダを参照して、デフォルト設定でTOEIC Part 7の問題を生成してください。
生成された問題は @問題 フォルダに自動保存してください。
```

### パラメータ指定
```
@問題生成器 フォルダを参照して、以下の条件でTOEIC Part 7の問題を生成してください：
- パッセージ数: 2
- 質問数: 5
- 難易度: 中級
- トピック: レストラン

生成された問題は @問題 フォルダに自動保存してください。
```

### キーワード認識
- "デフォルト設定" → config.yamlのdefaultセクションを使用
- "パッセージ数: X" → パッセージ数をXに設定
- "質問数: X" → 質問数をXに設定
- "難易度: X" → 難易度をXに設定（初級/中級/上級）
- "トピック: X" → トピックをXに設定
- "文書タイプ: X" → 文書タイプをXに設定

## 実行時のチェックリスト

問題生成を実行する際は、以下を確認：

- [ ] config.yamlを読み込んだ
- [ ] デフォルト設定またはユーザー指定のパラメータを取得した
- [ ] 問題番号を自動採番した
- [ ] 適切な問題生成プロンプトを作成した
- [ ] TOEIC Part 7の形式に準拠した問題を生成した
- [ ] 出力形式が正しいか確認した
- [ ] 問題ファイルを正しいパスに保存した
- [ ] ファイル名が正しい形式（{開始番号}-{終了番号}.md）になっている

## 品質基準

### 問題の品質
- 実際のTOEICテストと同じレベルの質を維持
- 自然で実践的な英語を使用
- ビジネス・日常シーンを反映
- 質問は文章の理解を測るもの（詳細理解、推論、語彙、主旨など）
- 選択肢は4つ（A-D）
- 誤答選択肢も適切に作成（明らかに間違っているものではなく、推論が必要なもの）

### 形式の品質
- Markdown形式が正しい
- 文章番号、質問番号が連番になっている
- 選択肢の形式が統一されている
- 文章間の区切り（`---`）が正しい

## トラブルシューティング

### 設定ファイルが見つからない場合
- エラーメッセージを表示
- デフォルト値（パッセージ数: 1, 質問数: 3, 難易度: 初級）を使用して続行

### 問題フォルダが見つからない場合
- エラーメッセージを表示
- ユーザーに確認を求める

### 問題番号の採番に失敗した場合
- 開始番号を1として処理を続行
- 警告メッセージを表示

## 拡張機能（オプション）

### 問題情報の記録
ユーザーが明示的に依頼した場合のみ：
- 問題情報（問題ID、問題ファイル、難易度、パッセージ数、トピック、問題タイプ）を
- `TOEIC部データ/problems_master.csv` に追記

### パーソナライズ問題生成
メンバーの弱点分析データがある場合：
- 弱点を克服するための問題を自動生成
- 難易度やトピックを個別に調整

## 注意事項

1. **自動実行**: ユーザーが問題生成を依頼した場合のみ実行
2. **設定の優先順位**: ユーザー指定 > config.yamlのデフォルト設定
3. **形式の厳守**: 必ず指定されたMarkdown形式で出力
4. **回答の非包含**: 問題文と質問のみを生成し、回答や解説は含めない
5. **既存ファイルの保護**: 既存の問題ファイルを上書きしない

